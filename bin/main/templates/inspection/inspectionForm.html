<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/defaultLayout}">
<head>
    <title th:text="${inspection.inspectionId == null ? 'New Inspection' : 'Edit Inspection'}">Inspection Form</title>
    <style>
        /* Optional: to ensure consistent spacing for remove buttons if needed */
        .action-col {
            width: 120px; /* Adjusted for icon + text */
            text-align: center;
        }
        .btn i { /* Add some margin if icon is next to text */
            margin-right: 0.25rem;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <h1 th:text="${inspection.inspectionId == null ? '예방점검 신규' : '예방점검 수정: ' + inspection.inspectionId}">Inspection Form</h1>
        <form th:action="@{/inspection/inspectionSave}" th:object="${inspection}" method="post">
            <!-- Hidden fields for the main inspection object -->
            <input type="hidden" th:field="*{companyId}" id="mainCompanyId" />
            <input type="hidden" th:field="*{createBy}" />
            <input type="hidden" th:field="*{createDate}" />
            <input type="hidden" th:field="*{updateBy}" />
            <input type="hidden" th:field="*{updateDate}" />
            <input type="hidden" th:field="*{inspectionId}" id="mainInspectionId" />

            <!-- Basic Information Card -->
            <div class="card mb-3">
                <div class="card-header">Basic Information</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2 mb-2">
                            <label class="form-label">ID</label>
                            <input type="text" class="form-control" th:value="*{inspectionId}" readonly disabled />
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label">Plant</label>
                            <input type="text" class="form-control" th:field="*{plantId}" />
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="form-label">Site</label>
                            <input type="text" class="form-control" th:field="*{siteId}" required />
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="form-label">Job Type</label>
                            <input type="text" class="form-control" th:field="*{jobType}" />
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label">Perform Dept</label>
                            <input type="text" class="form-control" th:field="*{performDept}" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Inspection Name</label>
                        <input type="text" class="form-control" th:field="*{inspectionName}" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" th:field="*{note}" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- Schedule Information Card -->
            <div class="card mb-3">
                <div class="card-header">Schedule Information</div>
                <div class="card-body">
                    <button type="button" class="btn btn-primary btn-sm mb-3" onclick="addSchedule()">
                        <i class="fas fa-plus-circle"></i> Add Schedule
                    </button>
                    <div id="scheduleContainer">
                        <!-- Thymeleaf loop for existing schedules -->
                        <div th:each="schedule, sStat : *{schedules}" class="border rounded p-3 mb-3 schedule-block">
                            <input type="hidden" th:field="*{schedules[__${sStat.index}__].scheduleId}" />
                            <input type="hidden" th:field="*{schedules[__${sStat.index}__].companyId}" />
                            <input type="hidden" th:field="*{schedules[__${sStat.index}__].inspectionId}" />
                            <div class="row mb-2">
                                <div class="col-md-5">
                                    <label class="form-label">Schedule Date</label>
                                    <input type="date" class="form-control" th:field="*{schedules[__${sStat.index}__].scheduleDate}"
                                           th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" />
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label" style="visibility: hidden;">Execute Date</label> <!-- Keep for alignment -->
                                    <input type="date" class="form-control" th:field="*{schedules[__${sStat.index}__].executeDate}" style="display: none;" />
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeSchedule(this)">
                                        <i class="fas fa-trash-alt"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Item Information Card -->
            <div class="card mb-3">
                <div class="card-header">Item Information</div>
                <div class="card-body">
                    <button type="button" class="btn btn-secondary btn-sm mb-3" onclick="addItem()">
                        <i class="fas fa-plus-circle"></i> Add Item
                    </button>
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Lower</th>
                                <th>Upper</th>
                                <th>Standard</th>
                                <th class="action-col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemContainerBody">
                            <!-- Thymeleaf loop for existing items (assuming inspection.items is a direct list) -->
                            <tr th:each="item, iStat : *{items}">
                                <input type="hidden" th:field="*{items[__${iStat.index}__].itemId}" />
                                <input type="hidden" th:field="*{items[__${iStat.index}__].companyId}" />
                                <input type="hidden" th:field="*{items[__${iStat.index}__].inspectionId}" />
                                <td><input type="text" class="form-control form-control-sm" th:field="*{items[__${iStat.index}__].itemName}" th:value="' '" /></td>
                                <td><input type="number" class="form-control form-control-sm" th:field="*{items[__${iStat.index}__].itemLower}" /></td>
                                <td><input type="number" class="form-control form-control-sm" th:field="*{items[__${iStat.index}__].itemUpper}" /></td>
                                <td><input type="text" class="form-control form-control-sm" th:field="*{items[__${iStat.index}__].itemStandard}" /></td>
                                <td class="action-col">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                                        <i class="fas fa-trash-alt"></i> Remove
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Inspection</button>
                <a th:href="@{/inspection/inspectionList(companyId=${inspection.companyId},siteId=${inspection.siteId})}" class="btn btn-secondary"><i class="fas fa-times-circle"></i> Cancel</a>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
/*<![CDATA[*/
    let scheduleCounter = /*[[${inspection.schedules != null ? inspection.schedules.size() : 0}]]*/ 0;
    let itemCounter = /*[[${inspection.items != null ? inspection.items.size() : 0}]]*/ 0;

    const mainCompanyId = document.getElementById('mainCompanyId').value;
    const mainInspectionId = document.getElementById('mainInspectionId').value;

    function addSchedule() {
        const container = document.getElementById('scheduleContainer');
        const idx = scheduleCounter;
        const html = `
        <div class="border rounded p-3 mb-3 schedule-block">
            <input type="hidden" name="schedules[${idx}].scheduleId" value="" />
            <input type="hidden" name="schedules[${idx}].companyId" value="${mainCompanyId || ''}" />
            <input type="hidden" name="schedules[${idx}].inspectionId" value="${mainInspectionId || ''}" />
            <div class="row mb-2">
                <div class="col-md-5">
                    <label class="form-label">Schedule Date</label>
                    <input type="date" class="form-control" name="schedules[${idx}].scheduleDate" />
                </div>
                <div class="col-md-5">
                    <label class="form-label" style="visibility: hidden;">Execute Date</label>
                    <input type="date" class="form-control" name="schedules[${idx}].executeDate" style="display: none;" />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeSchedule(this)">
                        <i class="fas fa-trash-alt"></i> Remove
                    </button>
                </div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
        scheduleCounter++;
    }

    function removeSchedule(btn) {
        btn.closest('.schedule-block').remove();
    }

    function addItem() {
        const tbody = document.getElementById('itemContainerBody');
        const itemIdx = itemCounter;
        const row = document.createElement('tr');
        row.innerHTML = `
            <input type="hidden" name="items[${itemIdx}].itemId" value="" />
            <input type="hidden" name="items[${itemIdx}].companyId" value="${mainCompanyId || ''}" />
            <input type="hidden" name="items[${itemIdx}].inspectionId" value="${mainInspectionId || ''}" />
            <td><input type="text" class="form-control form-control-sm" name="items[${itemIdx}].itemName" placeholder="Item Name" /></td>
            <td><input type="number" class="form-control form-control-sm" name="items[${itemIdx}].itemLower" placeholder="Lower" /></td>
            <td><input type="number" class="form-control form-control-sm" name="items[${itemIdx}].itemUpper" placeholder="Upper" /></td>
            <td><input type="text" class="form-control form-control-sm" name="items[${itemIdx}].itemStandard" placeholder="Standard" /></td>
            <td class="action-col">
                <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                    <i class="fas fa-trash-alt"></i> Remove
                </button>
            </td>
        `;
        tbody.appendChild(row);
        itemCounter++;
    }

    function removeItem(btn) {
        btn.closest('tr').remove();
    }
/*]]>*/
</script>
</body>
</html>
