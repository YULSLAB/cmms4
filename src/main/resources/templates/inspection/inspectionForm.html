<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/defaultLayout}">
<head>
    <title th:text="${inspection.inspectionId == null ? 'New Inspection' : 'Edit Inspection'}">Inspection Form</title>
    <style>
        .item-section {
            border-left: 1px solid #dee2e6;
            padding-left: 15px;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mt-4">
            <h1 th:text="${inspection.inspectionId == null ? '예방점검 신규' : '예방점검 수정: ' + inspection.inspectionId}">Inspection Form</h1>

            <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                <span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span th:text="${errorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <form th:action="@{/inspection/inspectionSave}" th:object="${inspection}" method="post" class="needs-validation" novalidate>
                <input type="hidden" th:field="*{companyId}" />
                <input type="hidden" th:field="*{createBy}" />
                <input type="hidden" th:field="*{createDate}" />
                <input type="hidden" th:field="*{updateBy}" />
                <input type="hidden" th:field="*{updateDate}" />

                <div class="card mb-3">
                    <div class="card-header">Inspection Details</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 mb-3">
                                <label for="inspectionId" class="form-label" th:text="#{inspection.label.id}">Inspection ID:</label>
                                <input type="text" class="form-control" id="inspectionId" th:value="${inspection.inspectionId}" readonly placeholder="자동생성" style="background-color: #e9ecef;" />
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="plantId" class="form-label" th:text="#{inspection.label.plant}">Plant ID:</label>
                                <input type="text" class="form-control" id="plantId" th:field="*{plantId}" />
                            </div>
                            <div class="col-md-1 mb-3">
                                <label for="siteId" class="form-label" th:text="#{inspection.label.site}">Site ID:</label>
                                <input type="text" class="form-control" id="siteId" th:field="*{siteId}" required />
                                <div class="invalid-feedback" th:text="#{inspection.validation.required.site}">Site ID is required.</div>
                            </div>
                            <div class="col-md-1 mb-3">
                                <label for="jobType" class="form-label" th:text="#{inspection.label.jobType}">Job Type:</label>
                                <input type="text" class="form-control" id="jobType" th:field="*{jobType}" />
                            </div>
                            <div class="col-md-1 mb-3">
                                <label for="performDept" class="form-label" th:text="#{inspection.label.performDept}">Performing Dept:</label>
                                <input type="text" class="form-control" id="performDept" th:field="*{performDept}" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-10 mb-3">
                                <label for="inspectionName" class="form-label" th:text="#{inspection.label.name}">Inspection Name:</label>
                                <input type="text" class="form-control" id="inspectionName" th:field="*{inspectionName}" required />
                                <div class="invalid-feedback" th:text="#{inspection.validation.required.name}">Inspection Name is required.</div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-10 mb-3">
                                <label for="note" class="form-label" th:text="#{inspection.label.note}">Note:</label>
                                <textarea class="form-control" id="note" th:field="*{note}" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-10 mb-3">
                                <label for="fileGroupId" class="form-label" th:text="#{inspection.label.fileGroup}">File Group ID:</label>
                                <input type="text" class="form-control" id="fileGroupId" th:field="*{fileGroupId}" />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">Inspection Schedules & Items</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <h5 th:text="#{inspection.schedule.header}">Schedules</h5>
                                <div th:each="schedule, sStat : ${inspection.schedules}">
                                    <div class="mb-3">
                                        <input type="hidden" th:field="*{schedules[__${sStat.index}__].scheduleId}" />
                                        <input type="date" class="form-control schedule-date" 
                                               th:field="*{schedules[__${sStat.index}__].scheduleDate}"
                                               th:data-schedule-id="${schedule.scheduleId != null ? schedule.scheduleId : 'new-' + sStat.index}"
                                               onchange="loadItems(this)" />
                                        <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeSchedule(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="addSchedule()">
                                    <i class="fas fa-plus"></i> <span th:text="#{inspection.schedule.add}">Add Date</span>
                                </button>
                            </div>

                            <div class="col-md-9 item-section">
                                <h5 th:text="#{inspection.items.header}">Items</h5>
                                <div id="itemsContainer">
                                    <div th:each="schedule, sStat : ${inspection.schedules}" 
                                         th:id="'items-' + (${schedule.scheduleId != null ? schedule.scheduleId : 'new-' + sStat.index})" style="display: none;">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th th:text="#{inspection.items.name}">Item Name</th>
                                                    <th th:text="#{inspection.items.lower}">Lower</th>
                                                    <th th:text="#{inspection.items.upper}">Upper</th>
                                                    <th th:text="#{inspection.items.standard}">Standard</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="item, iStat : ${schedule.items}">
                                                    <td><input type="text" class="form-control form-control-sm" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemName}" /></td>
                                                    <td><input type="number" class="form-control form-control-sm" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemLower}" /></td>
                                                    <td><input type="number" class="form-control form-control-sm" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemUpper}" /></td>
                                                    <td><input type="text" class="form-control form-control-sm" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemStandard}" /></td>
                                                    <td>
                                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <button type="button" class="btn btn-primary btn-sm" th:onclick="'addItem(\'' + (${schedule.scheduleId != null ? schedule.scheduleId : 'new-' + sStat.index}) + '\',' + ${sStat.index} + ')'">
                                            <i class="fas fa-plus"></i> Add Item
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary" th:text="#{inspection.button.save}">Save Inspection</button>
                    <a th:href="@{/inspection/inspectionList(companyId=${inspection.companyId}, siteId=${inspection.siteId})}" class="btn btn-secondary" th:text="#{common.cancel}">Cancel</a>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        function loadItems(dateInput) {
            let scheduleId = dateInput.dataset.scheduleId;
            if (!scheduleId) {
                const index = Array.from(document.querySelectorAll('.schedule-date')).indexOf(dateInput);
                scheduleId = 'new-' + index;
            }
            document.querySelectorAll('[id^="items-"]').forEach(div => div.style.display = 'none');
            const itemsDiv = document.getElementById('items-' + scheduleId);
            if (itemsDiv) itemsDiv.style.display = 'block';
        }

        function removeSchedule(button) {
            const div = button.closest('.mb-3');
            div.remove();
        }

        function addSchedule() {
            alert('일정 추가는 서버 측 인덱스 동기화가 필요하여 이 예제에서는 지원하지 않습니다.');
        }

        function addItem(scheduleId, scheduleIndex) {
            const tbody = document.querySelector(`#items-${scheduleId} tbody`);
            const itemCount = tbody.querySelectorAll('tr').length;
            const newRow = `
                <tr>
                    <td><input type="text" class="form-control form-control-sm" name="schedules[${scheduleIndex}].items[${itemCount}].itemName" /></td>
                    <td><input type="number" class="form-control form-control-sm" name="schedules[${scheduleIndex}].items[${itemCount}].itemLower" /></td>
                    <td><input type="number" class="form-control form-control-sm" name="schedules[${scheduleIndex}].items[${itemCount}].itemUpper" /></td>
                    <td><input type="text" class="form-control form-control-sm" name="schedules[${scheduleIndex}].items[${itemCount}].itemStandard" /></td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', newRow);
        }

        function removeItem(button) {
            button.closest('tr').remove();
        }

        window.addEventListener('DOMContentLoaded', function () {
            const firstDateInput = document.querySelector('.schedule-date');
            if (firstDateInput) loadItems(firstDateInput);
        });
    </script>
</body>
</html>
