<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/defaultLayout}">
<head>
    <title th:text="${inspection.inspectionId == null ? 'New Inspection' : 'Edit Inspection'}">Inspection Form</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <h1 th:text="${inspection.inspectionId == null ? '예방점검 신규' : '예방점검 수정: ' + inspection.inspectionId}">Inspection Form</h1>
        <form th:action="@{/inspection/inspectionSave}" th:object="${inspection}" method="post">
            <input type="hidden" th:field="*{companyId}" />
            <input type="hidden" th:field="*{createBy}" />
            <input type="hidden" th:field="*{createDate}" />
            <input type="hidden" th:field="*{updateBy}" />
            <input type="hidden" th:field="*{updateDate}" />
            <div class="card mb-3">
                <div class="card-header">Inspection Details</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2 mb-2">
                            <label class="form-label">ID</label>
                            <input type="text" class="form-control" th:field="*{inspectionId}" readonly />
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label">Plant</label>
                            <input type="text" class="form-control" th:field="*{plantId}" />
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="form-label">Site</label>
                            <input type="text" class="form-control" th:field="*{siteId}" required />
                        </div>
                        <div class="col-md-2 mb-2">
                            <label class="form-label">Job Type</label>
                            <input type="text" class="form-control" th:field="*{jobType}" />
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label">Perform Dept</label>
                            <input type="text" class="form-control" th:field="*{performDept}" />
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Inspection Name</label>
                        <input type="text" class="form-control" th:field="*{inspectionName}" required />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" th:field="*{note}" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">Schedules & Items</div>
                <div class="card-body" id="scheduleContainer">
                    <div th:each="schedule,sStat : ${inspection.schedules}" class="border rounded p-3 mb-3 schedule-block">
                        <input type="hidden" th:field="*{schedules[__${sStat.index}__].scheduleId}" />
                        <input type="hidden" th:field="*{schedules[__${sStat.index}__].companyId}" />
                        <input type="hidden" th:field="*{schedules[__${sStat.index}__].inspectionId}" />
                        <div class="row mb-2">
                            <div class="col-md-4">
                                <label class="form-label">Schedule Date</label>
                                <input type="date" class="form-control" th:field="*{schedules[__${sStat.index}__].scheduleDate}" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Execute Date</label>
                                <input type="date" class="form-control" th:field="*{schedules[__${sStat.index}__].executeDate}" />
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="button" class="btn btn-danger btn-sm" onclick="removeSchedule(this)">Remove</button>
                            </div>
                        </div>
                        <table class="table table-sm">
                            <thead>
                            <tr><th>Item Name</th><th>Lower</th><th>Upper</th><th>Standard</th><th></th></tr>
                            </thead>
                            <tbody>
                            <tr th:each="item,iStat : ${schedule.items}">
                                <input type="hidden" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemId}" />
                                <td><input type="text" class="form-control form-control-sm" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemName}" /></td>
                                <td><input type="number" class="form-control form-control-sm" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemLower}" /></td>
                                <td><input type="number" class="form-control form-control-sm" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemUpper}" /></td>
                                <td><input type="text" class="form-control form-control-sm" th:field="*{schedules[__${sStat.index}__].items[__${iStat.index}__].itemStandard}" /></td>
                                <td><button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">Remove</button></td>
                            </tr>
                            </tbody>
                        </table>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addItem(this, [[${sStat.index}]])">Add Item</button>
                    </div>
                </div>
                <button type="button" class="btn btn-primary btn-sm" onclick="addSchedule()">Add Schedule</button>
            </div>
            <div class="mt-4">
                <button type="submit" class="btn btn-primary">Save Inspection</button>
                <a th:href="@{/inspection/inspectionList(companyId=${inspection.companyId},siteId=${inspection.siteId})}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
<script th:inline="javascript">
let scheduleCounter = /*[[${inspection.schedules != null ? inspection.schedules.size() : 0}]]*/ 0;
function addSchedule(){
    const container=document.getElementById('scheduleContainer');
    const idx=scheduleCounter;
    const html=`<div class="border rounded p-3 mb-3 schedule-block">
        <input type="hidden" name="schedules[${idx}].scheduleId" />
        <input type="hidden" name="schedules[${idx}].companyId" value="[[${inspection.companyId}]]" />
        <input type="hidden" name="schedules[${idx}].inspectionId" value="[[${inspection.inspectionId}]]" />
        <div class="row mb-2">
            <div class="col-md-4"><input type="date" class="form-control" name="schedules[${idx}].scheduleDate" /></div>
            <div class="col-md-4"><input type="date" class="form-control" name="schedules[${idx}].executeDate" /></div>
            <div class="col-md-2 d-flex align-items-end"><button type="button" class="btn btn-danger btn-sm" onclick="removeSchedule(this)">Remove</button></div>
        </div>
        <table class="table table-sm"><thead><tr><th>Item Name</th><th>Lower</th><th>Upper</th><th>Standard</th><th></th></tr></thead><tbody></tbody></table>
        <button type="button" class="btn btn-secondary btn-sm" onclick="addItem(this, ${idx})">Add Item</button>
    </div>`;
    container.insertAdjacentHTML('beforeend',html);
    scheduleCounter++;
}
function removeSchedule(btn){btn.closest('.schedule-block').remove();}
function addItem(button,idx){const tbody=button.parentElement.querySelector('tbody');const count=tbody.querySelectorAll('tr').length;const row=`<tr>
    <input type="hidden" name="schedules[${idx}].items[${count}].itemId" />
    <td><input type="text" class="form-control form-control-sm" name="schedules[${idx}].items[${count}].itemName" /></td>
    <td><input type="number" class="form-control form-control-sm" name="schedules[${idx}].items[${count}].itemLower" /></td>
    <td><input type="number" class="form-control form-control-sm" name="schedules[${idx}].items[${count}].itemUpper" /></td>
    <td><input type="text" class="form-control form-control-sm" name="schedules[${idx}].items[${count}].itemStandard" /></td>
    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeItem(this)">Remove</button></td>
</tr>`;tbody.insertAdjacentHTML('beforeend',row);}
function removeItem(btn){btn.closest('tr').remove();}
</script>
</body>
</html>
